---
title: "Portfolio Performance Report"
date: "`r Sys.Date()`"
output: pdf_document
params:
  data: NA
  start_date: NA
  end_date: NA
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
library(tidyverse)
library(scales)
```

## Period Info

**From:** `r params$start_date`  
**To:** `r params$end_date`

## Summary

```{r}
df <- params$data

if (nrow(df) == 0) {
  cat("No data found for this period.")
} else {
  # Calculate summary stats based on snapshots
  # Assuming df has snapshot_date, value, account
  
  # Total Value at Start vs End
  start_val <- df |> filter(snapshot_date == min(snapshot_date)) |> summarise(sum(value, na.rm=T)) |> pull()
  end_val <- df |> filter(snapshot_date == max(snapshot_date)) |> summarise(sum(value, na.rm=T)) |> pull()
  
  change <- end_val - start_val
  pct_change <- ifelse(start_val != 0, change / start_val, 0)
  
  cat(paste0("**Start Value:** ", dollar(start_val), "\n\n"))
  cat(paste0("**End Value:** ", dollar(end_val), "\n\n"))
  cat(paste0("**Net Change:** ", dollar(change), " (", percent(pct_change), ")"))
}
```

## Allocation

```{r}
if (nrow(df) > 0) {
  latest_date <- max(df$snapshot_date)
  latest_df <- df |> filter(snapshot_date == latest_date)
  
  latest_df |>
    group_by(asset_class) |>
    summarise(value = sum(value, na.rm=T)) |>
    mutate(prop = value / sum(value)) |>
    ggplot(aes(x = "", y = prop, fill = asset_class)) +
    geom_col() +
    coord_polar("y") +
    theme_void() +
    labs(title = paste("Asset Allocation as of", latest_date), fill = "Asset Class")
}
```

## History

```{r}
if (nrow(df) > 0) {
  df |>
    group_by(snapshot_date) |>
    summarise(total = sum(value, na.rm=T)) |>
    ggplot(aes(x = snapshot_date, y = total)) +
    geom_line(color = "steelblue") +
    scale_y_continuous(labels = dollar_format()) +
    theme_minimal() +
    labs(title = "Portfolio Value Over Time", x = "", y = "Value")
}
```
